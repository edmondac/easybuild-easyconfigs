easyblock = 'ConfigureMake'

name = 'Xmipp'
version = '3.1'

homepage = 'http://xmipp.cnb.csic.es/'
description = "Xmipp is a suite of image processing programs, primarily aimed at single-particle 3D electron microscopy."

source_urls = ['http://xmipp.cnb.csic.es/Downloads/']
sources = ['Xmipp-%(version)s-src.tar.gz']

toolchain = {'name': 'intel', 'version': '2015a'}

patches = ['sqlite_imports.patch', 'library_imports.patch']

dependencies = [
    ('Python', '2.7.9'),
    ('Java', '1.8.0_25', '', True),  # TODO: set this to yes in configure
    ('freetype', '2.5.3'),
    ('gtest', '1.6.0'),  # TODO: set this to yes in configure, after patching out all the includes for external/gtest
    ('LibTIFF', '4.0.3'),
    ('HDF5', '1.8.14', '-gpfs'),
    ('libjpeg-turbo', '1.3.1'),
    ('FFTW', '3.3.4'),
]

buildininstalldir = True
unpack_options = '--strip-components=1'

sanity_check_paths = {
    'files': ['bin/xmipp_mpi_run'],
    'dirs': [],
}

preconfigopts = """export CXXFLAGS="$CXXFFLAGS  -DMPICH_IGNORE_CXX_SEEK -I$EBROOTPYTHON/include/python2.7" && ln -s `which python` xmipp_python && mkdir lib && ln -s $EBROOTPYTHON/lib/python2.7 lib/python2.7 && cd external && tar xf scons.tgz && tar xf bilib.tgz && tar xf condor.tgz && tar xf alglib-3.8.0.cpp.tgz && cd - && mkdir bin && PATH=$PWD:$PATH  xmipp_python external/scons/scons.py mode=configure -j 4 --config=force  profile=no fast=yes warn=no release=yes gtest=no cuda=no debug=no matlab=no java=no LINKERFORPROGRAMS="$CXX" MPI_BINDIR="$EBROOTIMPI" JAVA_HOME="$JAVA_HOME" JAVAC=javac CC="$CC" CXXFLAGS="$CXXFLAGS" CXX="$CXX" MPI_CC="$MPICC" MPI_CXX="$MPICXX" MPI_INCLUDE="$MPI_INC_DIR" MPI_LIBDIR="$MPI_LIB_DIR" MPI_LINKERFORPROGRAMS="$MPICC" LIBPATH="$LD_LIBRARY_PATH" || """

prebuildopts = """export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$PWD/lib && PATH=$PWD:$PATH xmipp_python external/scons/scons.py mode=compile -j 16 || """

preinstallopts = "XMIPP_HOME=%(installdir)s PATH=$PWD:$PWD/bin:$PATH PYTHONPATH=$PYTHONPATH:$PWD/protocols:$PWD/libraries/bindings/python/:$EBROOTPYTHON/lib/python2.7/lib-dynload/ python setup.py install || "

moduleclass = 'vis'
